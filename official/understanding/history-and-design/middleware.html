<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>middleware</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
</head>
<body>
<p><a href="#main" class="skipToContent_1oUP">Skip to main content</a></p>
<p>Menu</p>
<p><a href="../../index.html" class="navbar__brand"><img src="../../../d33wubrfki0l68.cloudfront.net/0834d0215db51e91525a25acf97433051f280f2f/c30f5/img/redux.svg" alt="Redux Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo" /><img src="../../../d33wubrfki0l68.cloudfront.net/0834d0215db51e91525a25acf97433051f280f2f/c30f5/img/redux.svg" alt="Redux Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo" /><strong>Redux</strong></a></p>
<p><a href="../../index.html" class="navbar__brand"><img src="../../../d33wubrfki0l68.cloudfront.net/0834d0215db51e91525a25acf97433051f280f2f/c30f5/img/redux.svg" alt="Redux Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo" /><img src="../../../d33wubrfki0l68.cloudfront.net/0834d0215db51e91525a25acf97433051f280f2f/c30f5/img/redux.svg" alt="Redux Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo" /><strong>Redux</strong></a></p>
<ul>
<li><a href="../../introduction/getting-started.html" class="menu__link">Getting Started</a></li>
<li><a href="../../tutorials/essentials/part-1-overview-concepts.html" class="menu__link">Tutorial</a></li>
<li><a href="../../api/api-reference.html" class="menu__link">API</a></li>
<li><a href="../../faq.html" class="menu__link">FAQ</a></li>
<li><a href="../../style-guide/style-guide.html" class="menu__link">Best Practices</a></li>
<li><a href="../../../github.com/reduxjs/redux.html" class="menu__link">GitHub</a></li>
<li><a href="../../introduction/getting-started.html#help-and-discussion" class="menu__link">Need help?</a></li>
</ul>
<p>Menu</p>
<ul>
<li><a href="#!" class="menu__link menu__link--sublist">Introduction</a>
<ul>
<li><a href="../../introduction/getting-started.html" class="menu__link">Getting Started with Redux</a></li>
<li><a href="../../introduction/installation.html" class="menu__link">Installation</a></li>
<li><a href="../../introduction/core-concepts.html" class="menu__link">Core Concepts</a></li>
<li><a href="../../introduction/learning-resources.html" class="menu__link">Learning Resources</a></li>
<li><a href="../../introduction/ecosystem.html" class="menu__link">Ecosystem</a></li>
<li><a href="../../introduction/examples.html" class="menu__link">Examples</a></li>
</ul></li>
<li><p><a href="#!" class="menu__link menu__link--sublist">Tutorials</a></p>
<ul>
<li><a href="../../tutorials/index.html" class="menu__link">Tutorials Index</a></li>
<li><a href="../../tutorials/quick-start.html" class="menu__link">Quick Start</a></li>
<li><a href="../../tutorials/typescript-quick-start.html" class="menu__link">TypeScript Quick Start</a></li>
<li><p><a href="#!" class="menu__link menu__link--sublist">Redux Essentials</a></p>
<ul>
<li><a href="../../tutorials/essentials/part-1-overview-concepts.html" class="menu__link">Redux Overview and Concepts</a></li>
<li><a href="../../tutorials/essentials/part-2-app-structure.html" class="menu__link">Redux App Structure</a></li>
<li><a href="../../tutorials/essentials/part-3-data-flow.html" class="menu__link">Basic Redux Data Flow</a></li>
<li><a href="../../tutorials/essentials/part-4-using-data.html" class="menu__link">Using Redux Data</a></li>
<li><a href="../../tutorials/essentials/part-5-async-logic.html" class="menu__link">Async Logic and Data Fetching</a></li>
<li><p><a href="../../tutorials/essentials/part-6-performance-normalization.html" class="menu__link">Performance and Normalizing Data</a></p></li>
<li><a href="../../tutorials/fundamentals/part-1-overview.html" class="menu__link">Redux Overview</a></li>
<li><a href="../../tutorials/fundamentals/part-2-concepts-data-flow.html" class="menu__link">Redux Concepts and Data Flow</a></li>
<li><a href="../../tutorials/fundamentals/part-3-state-actions-reducers.html" class="menu__link">State, Actions, and Reducers</a></li>
<li><a href="../../tutorials/fundamentals/part-4-store.html" class="menu__link">Store</a></li>
<li><a href="../../tutorials/fundamentals/part-5-ui-react.html" class="menu__link">UI and React</a></li>
<li><a href="../../tutorials/fundamentals/part-6-async-logic.html" class="menu__link">Async Logic and Data Fetching</a></li>
<li><a href="../../tutorials/fundamentals/part-7-standard-patterns.html" class="menu__link">Standard Redux Patterns</a></li>
<li><p><a href="../../tutorials/fundamentals/part-8-modern-redux.html" class="menu__link">Modern Redux with Redux Toolkit</a></p></li>
<li><a href="../../recipes/structuring-reducers/structuring-reducers.html" class="menu__link">Structuring Reducers</a></li>
<li><a href="../../recipes/structuring-reducers/prerequisite-concepts.html" class="menu__link">Prerequisite Concepts</a></li>
<li><a href="../../recipes/structuring-reducers/basic-reducer-structure.html" class="menu__link">Basic Reducer Structure</a></li>
<li><a href="../../recipes/structuring-reducers/splitting-reducer-logic.html" class="menu__link">Splitting Reducer Logic</a></li>
<li><a href="../../recipes/structuring-reducers/refactoring-reducer-example.html" class="menu__link">Refactoring Reducers Example</a></li>
<li><a href="../../recipes/structuring-reducers/using-combinereducers.html" class="menu__link">Using combineReducers</a></li>
<li><a href="../../recipes/structuring-reducers/beyond-combinereducers.html" class="menu__link">Beyond combineReducers</a></li>
<li><a href="../../recipes/structuring-reducers/normalizing-state-shape.html" class="menu__link">Normalizing State Shape</a></li>
<li><a href="../../recipes/structuring-reducers/updating-normalized-data.html" class="menu__link">Updating Normalized Data</a></li>
<li><a href="../../recipes/structuring-reducers/reusing-reducer-logic.html" class="menu__link">Reusing Reducer Logic</a></li>
<li><a href="../../recipes/structuring-reducers/immutable-update-patterns.html" class="menu__link">Immutable Update Patterns</a></li>
<li><p><a href="../../recipes/structuring-reducers/initializing-state.html" class="menu__link">Initializing State</a></p></li>
</ul></li>
</ul></li>
<li><a href="#!" class="menu__link menu__link--sublist menu__link--active">Understanding Redux</a>
<ul>
<li><a href="#!" class="menu__link menu__link--sublist">Thinking in Redux</a>
<ul>
<li><a href="../thinking-in-redux/motivation.html" class="menu__link">Motivation</a></li>
<li><a href="../thinking-in-redux/three-principles.html" class="menu__link">Three Principles</a></li>
<li><a href="../thinking-in-redux/glossary.html" class="menu__link">Glossary</a></li>
</ul></li>
<li><a href="#!" class="menu__link menu__link--sublist menu__link--active">History and Design</a>
<ul>
<li><a href="prior-art.html" class="menu__link">Prior Art</a></li>
<li><a href="middleware.html" class="menu__link menu__link--active active">Middleware</a></li>
</ul></li>
</ul></li>
<li><a href="#!" class="menu__link menu__link--sublist">FAQ</a>
<ul>
<li><a href="../../faq.html" class="menu__link">FAQ Index</a></li>
<li><a href="../../faq/general.html" class="menu__link">General</a></li>
<li><a href="../../faq/reducers.html" class="menu__link">Reducers</a></li>
<li><a href="../../faq/organizing-state.html" class="menu__link">Organizing State</a></li>
<li><a href="../../faq/store-setup.html" class="menu__link">Store Setup</a></li>
<li><a href="../../faq/actions.html" class="menu__link">Actions</a></li>
<li><a href="../../faq/immutable-data.html" class="menu__link">Immutable Data</a></li>
<li><a href="../../faq/code-structure.html" class="menu__link">Code Structure</a></li>
<li><a href="../../faq/performance.html" class="menu__link">Performance</a></li>
<li><a href="../../faq/design-decisions.html" class="menu__link">Design Decisions</a></li>
</ul></li>
</ul>
<h1 id="middleware"><span id="middleware" class="anchor enhancedAnchor_2LWZ"></span>Middleware<a href="#middleware" class="hash-link" title="Direct link to heading">#</a></h1>
<p>You’ve seen middleware in action in the <a href="../../tutorials/fundamentals/part-4-store.html#middleware">“Redux Fundamentals” tutorial</a>. If you’ve used server-side libraries like <a href="../../../expressjs.com/index.html">Express</a> and <a href="../../../koajs.com/index.html">Koa</a>, you were also probably already familiar with the concept of <em>middleware</em>. In these frameworks, middleware is some code you can put between the framework receiving a request, and the framework generating a response. For example, Express or Koa middleware may add CORS headers, logging, compression, and more. The best feature of middleware is that it’s composable in a chain. You can use multiple independent third-party middleware in a single project.</p>
<p>Redux middleware solves different problems than Express or Koa middleware, but in a conceptually similar way. <strong>It provides a third-party extension point between dispatching an action, and the moment it reaches the reducer.</strong> People use Redux middleware for logging, crash reporting, talking to an asynchronous API, routing, and more.</p>
<p>This article is divided into an in-depth intro to help you grok the concept, and <a href="#seven-examples">a few practical examples</a> to show the power of middleware at the very end. You may find it helpful to switch back and forth between them, as you flip between feeling bored and inspired.</p>
<h2 id="understanding-middleware"><span id="understanding-middleware" class="anchor enhancedAnchor_2LWZ"></span>Understanding Middleware<a href="#understanding-middleware" class="hash-link" title="Direct link to heading">#</a></h2>
<p>While middleware can be used for a variety of things, including asynchronous API calls, it’s really important that you understand where it comes from. We’ll guide you through the thought process leading to middleware, by using logging and crash reporting as examples.</p>
<h3 id="problem-logging"><span id="problem-logging" class="anchor enhancedAnchor_2LWZ"></span>Problem: Logging<a href="#problem-logging" class="hash-link" title="Direct link to heading">#</a></h3>
<p>One of the benefits of Redux is that it makes state changes predictable and transparent. Every time an action is dispatched, the new state is computed and saved. The state cannot change by itself, it can only change as a consequence of a specific action.</p>
<p>Wouldn’t it be nice if we logged every action that happens in the app, together with the state computed after it? When something goes wrong, we can look back at our log, and figure out which action corrupted the state.</p>
<p><img src="../../../i.imgur.com/BjGBlES.png" style="width:70.0%" /></p>
<p>How do we approach this with Redux?</p>
<h3 id="attempt-1-logging-manually"><span id="attempt-1-logging-manually" class="anchor enhancedAnchor_2LWZ"></span>Attempt #1: Logging Manually<a href="#attempt-1-logging-manually" class="hash-link" title="Direct link to heading">#</a></h3>
<p>The most naïve solution is just to log the action and the next state yourself every time you call <a href="../../api/store.html#dispatchaction"><code>store.dispatch(action)</code></a>. It’s not really a solution, but just a first step towards understanding the problem.</p>
<blockquote>
<h5 id="note"><span id="note" class="anchor enhancedAnchor_2LWZ"></span>Note<a href="#note" class="hash-link" title="Direct link to heading">#</a></h5>
<p>If you’re using <a href="../../../github.com/reduxjs/react-redux.html">react-redux</a> or similar bindings, you likely won’t have direct access to the store instance in your components. For the next few paragraphs, just assume you pass the store down explicitly.</p>
</blockquote>
<p>Say, you call this when creating a todo:</p>
<p><span>store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">dispatch</span><span class="token punctuation" style="color: #000000">(</span><span class="token function" style="color: #e6d874">addTodo</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘Use Redux’</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span>To log the action and state, you can change it to something like this:</p>
<p><span class="token keyword" style="color: #f92672">const</span><span> action </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">addTodo</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘Use Redux’</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span></span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘dispatching’</span><span class="token punctuation" style="color: #000000">,</span><span> action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span>store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">dispatch</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span></span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘next state’</span><span class="token punctuation" style="color: #000000">,</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span>This produces the desired effect, but you wouldn’t want to do it every time.</p>
<h3 id="attempt-2-wrapping-dispatch"><span id="attempt-2-wrapping-dispatch" class="anchor enhancedAnchor_2LWZ"></span>Attempt #2: Wrapping Dispatch<a href="#attempt-2-wrapping-dispatch" class="hash-link" title="Direct link to heading">#</a></h3>
<p>You can extract logging into a function:</p>
<p><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">dispatchAndLog</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">store</span><span class="token parameter punctuation" style="color: #000000">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘dispatching’</span><span class="token punctuation" style="color: #000000">,</span><span> action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">dispatch</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘next state’</span><span class="token punctuation" style="color: #000000">,</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span>You can then use it everywhere instead of <code>store.dispatch()</code>:</p>
<p><span class="token function" style="color: #e6d874">dispatchAndLog</span><span class="token punctuation" style="color: #000000">(</span><span>store</span><span class="token punctuation" style="color: #000000">,</span><span> </span><span class="token function" style="color: #e6d874">addTodo</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘Use Redux’</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span>We could end this here, but it’s not very convenient to import a special function every time.</p>
<h3 id="attempt-3-monkeypatching-dispatch"><span id="attempt-3-monkeypatching-dispatch" class="anchor enhancedAnchor_2LWZ"></span>Attempt #3: Monkeypatching Dispatch<a href="#attempt-3-monkeypatching-dispatch" class="hash-link" title="Direct link to heading">#</a></h3>
<p>What if we just replace the <code>dispatch</code> function on the store instance? The Redux store is a plain object with <a href="../../api/store.html">a few methods</a>, and we’re writing JavaScript, so we can just monkeypatch the <code>dispatch</code> implementation:</p>
<p><span class="token keyword" style="color: #f92672">const</span><span> next </span><span class="token operator" style="color: #000000">=</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">dispatch</span><span></span></p>
<p><span>store</span><span class="token punctuation" style="color: #000000">.</span><span class="token method-variable function-variable method function property-access" style="color: #e6d874">dispatch</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">dispatchAndLog</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">action</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘dispatching’</span><span class="token punctuation" style="color: #000000">,</span><span> action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">let</span><span> result </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘next state’</span><span class="token punctuation" style="color: #000000">,</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> result</span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span>This is already closer to what we want! No matter where we dispatch an action, it is guaranteed to be logged. Monkeypatching never feels right, but we can live with this for now.</p>
<h3 id="problem-crash-reporting"><span id="problem-crash-reporting" class="anchor enhancedAnchor_2LWZ"></span>Problem: Crash Reporting<a href="#problem-crash-reporting" class="hash-link" title="Direct link to heading">#</a></h3>
<p>What if we want to apply <strong>more than one</strong> such transformation to <code>dispatch</code>?</p>
<p>A different useful transformation that comes to my mind is reporting JavaScript errors in production. The global <code>window.onerror</code> event is not reliable because it doesn’t provide stack information in some older browsers, which is crucial to understand why an error is happening.</p>
<p>Wouldn’t it be useful if, any time an error is thrown as a result of dispatching an action, we would send it to a crash reporting service like <a href="../../../getsentry.com/welcome/index.html">Sentry</a> with the stack trace, the action that caused the error, and the current state? This way it’s much easier to reproduce the error in development.</p>
<p>However, it is important that we keep logging and crash reporting separate. Ideally we want them to be different modules, potentially in different packages. Otherwise we can’t have an ecosystem of such utilities. (Hint: we’re slowly getting to what middleware is!)</p>
<p>If logging and crash reporting are separate utilities, they might look like this:</p>
<p><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">patchStoreToAddLogging</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">store</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">const</span><span> next </span><span class="token operator" style="color: #000000">=</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">dispatch</span><span></span></p>
<p><span> store</span><span class="token punctuation" style="color: #000000">.</span><span class="token method-variable function-variable method function property-access" style="color: #e6d874">dispatch</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">dispatchAndLog</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">action</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘dispatching’</span><span class="token punctuation" style="color: #000000">,</span><span> action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">let</span><span> result </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘next state’</span><span class="token punctuation" style="color: #000000">,</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> result</span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span></span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">patchStoreToAddCrashReporting</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">store</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">const</span><span> next </span><span class="token operator" style="color: #000000">=</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">dispatch</span><span></span></p>
<p><span> store</span><span class="token punctuation" style="color: #000000">.</span><span class="token method-variable function-variable method function property-access" style="color: #e6d874">dispatch</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">dispatchAndReportErrors</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">action</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">try</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span> </span><span class="token keyword control-flow" style="color: #f92672">catch</span><span> </span><span class="token punctuation" style="color: #000000">(</span><span>err</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">error</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘Caught an exception!’</span><span class="token punctuation" style="color: #000000">,</span><span> err</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token maybe-class-name">Raven</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">captureException</span><span class="token punctuation" style="color: #000000">(</span><span>err</span><span class="token punctuation" style="color: #000000">,</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> extra</span><span class="token operator" style="color: #000000">:</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> action</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> state</span><span class="token operator" style="color: #000000">:</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">throw</span><span> err</span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span>If these functions are published as separate modules, we can later use them to patch our store:</p>
<p><span class="token function" style="color: #e6d874">patchStoreToAddLogging</span><span class="token punctuation" style="color: #000000">(</span><span>store</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span></span><span class="token function" style="color: #e6d874">patchStoreToAddCrashReporting</span><span class="token punctuation" style="color: #000000">(</span><span>store</span><span class="token punctuation" style="color: #000000">)</span>Still, this isn’t nice.</p>
<h3 id="attempt-4-hiding-monkeypatching"><span id="attempt-4-hiding-monkeypatching" class="anchor enhancedAnchor_2LWZ"></span>Attempt #4: Hiding Monkeypatching<a href="#attempt-4-hiding-monkeypatching" class="hash-link" title="Direct link to heading">#</a></h3>
<p>Monkeypatching is a hack. “Replace any method you like”, what kind of API is that? Let’s figure out the essence of it instead. Previously, our functions replaced <code>store.dispatch</code>. What if they <em>returned</em> the new <code>dispatch</code> function instead?</p>
<p><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">logger</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">store</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">const</span><span> next </span><span class="token operator" style="color: #000000">=</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">dispatch</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token comment" style="color: #c6cad2">// Previously:</span><span></span></p>
<p><span> </span><span class="token comment" style="color: #c6cad2">// store.dispatch = function dispatchAndLog(action) {</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">dispatchAndLog</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">action</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘dispatching’</span><span class="token punctuation" style="color: #000000">,</span><span> action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">let</span><span> result </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘next state’</span><span class="token punctuation" style="color: #000000">,</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> result</span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span>We could provide a helper inside Redux that would apply the actual monkeypatching as an implementation detail:</p>
<p><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">applyMiddlewareByMonkeypatching</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">store</span><span class="token parameter punctuation" style="color: #000000">,</span><span class="token parameter"> middlewares</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> middlewares </span><span class="token operator" style="color: #000000">=</span><span> middlewares</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">slice</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> middlewares</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">reverse</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token comment" style="color: #c6cad2">// Transform dispatch function with each middleware.</span><span></span></p>
<p><span> middlewares</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">forEach</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">middleware</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">(</span><span>store</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">dispatch</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">middleware</span><span class="token punctuation" style="color: #000000">(</span><span>store</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span>We could use it to apply multiple middleware like this:</p>
<p><span class="token function" style="color: #e6d874">applyMiddlewareByMonkeypatching</span><span class="token punctuation" style="color: #000000">(</span><span>store</span><span class="token punctuation" style="color: #000000">,</span><span> </span><span class="token punctuation" style="color: #000000">[</span><span>logger</span><span class="token punctuation" style="color: #000000">,</span><span> crashReporter</span><span class="token punctuation" style="color: #000000">]</span><span class="token punctuation" style="color: #000000">)</span>However, it is still monkeypatching. The fact that we hide it inside the library doesn’t alter this fact.</p>
<h3 id="attempt-5-removing-monkeypatching"><span id="attempt-5-removing-monkeypatching" class="anchor enhancedAnchor_2LWZ"></span>Attempt #5: Removing Monkeypatching<a href="#attempt-5-removing-monkeypatching" class="hash-link" title="Direct link to heading">#</a></h3>
<p>Why do we even overwrite <code>dispatch</code>? Of course, to be able to call it later, but there’s also another reason: so that every middleware can access (and call) the previously wrapped <code>store.dispatch</code>:</p>
<p><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">logger</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">store</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token comment" style="color: #c6cad2">// Must point to the function returned by the previous middleware:</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">const</span><span> next </span><span class="token operator" style="color: #000000">=</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">dispatch</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">dispatchAndLog</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">action</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘dispatching’</span><span class="token punctuation" style="color: #000000">,</span><span> action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">let</span><span> result </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘next state’</span><span class="token punctuation" style="color: #000000">,</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> result</span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span>It is essential to chaining middleware!</p>
<p>If <code>applyMiddlewareByMonkeypatching</code> doesn’t assign <code>store.dispatch</code> immediately after processing the first middleware, <code>store.dispatch</code> will keep pointing to the original <code>dispatch</code> function. Then the second middleware will also be bound to the original <code>dispatch</code> function.</p>
<p>But there’s also a different way to enable chaining. The middleware could accept the <code>next()</code> dispatch function as a parameter instead of reading it from the <code>store</code> instance.</p>
<p><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">logger</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">store</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">wrapDispatchToAddLogging</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">next</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">dispatchAndLog</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">action</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘dispatching’</span><span class="token punctuation" style="color: #000000">,</span><span> action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">let</span><span> result </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘next state’</span><span class="token punctuation" style="color: #000000">,</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> result</span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span>It’s a <a href="../../../knowyourmeme.com/memes/we-need-to-go-deeper.html">“we need to go deeper”</a> kind of moment, so it might take a while for this to make sense. The function cascade feels intimidating. ES6 arrow functions make this <a href="../../../en.wikipedia.org/wiki/Currying.html">currying</a> easier on eyes:</p>
<p><span class="token keyword" style="color: #f92672">const</span><span> </span><span class="token function-variable function" style="color: #e6d874">logger</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token parameter">store</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">next</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">action</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘dispatching’</span><span class="token punctuation" style="color: #000000">,</span><span> action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">let</span><span> result </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘next state’</span><span class="token punctuation" style="color: #000000">,</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> result</span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> </span><span class="token function-variable function" style="color: #e6d874">crashReporter</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token parameter">store</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">next</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">action</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">try</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span> </span><span class="token keyword control-flow" style="color: #f92672">catch</span><span> </span><span class="token punctuation" style="color: #000000">(</span><span>err</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">error</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘Caught an exception!’</span><span class="token punctuation" style="color: #000000">,</span><span> err</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token maybe-class-name">Raven</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">captureException</span><span class="token punctuation" style="color: #000000">(</span><span>err</span><span class="token punctuation" style="color: #000000">,</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> extra</span><span class="token operator" style="color: #000000">:</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> action</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> state</span><span class="token operator" style="color: #000000">:</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">throw</span><span> err</span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span><strong>This is exactly what Redux middleware looks like.</strong></p>
<p>Now middleware takes the <code>next()</code> dispatch function, and returns a dispatch function, which in turn serves as <code>next()</code> to the middleware to the left, and so on. It’s still useful to have access to some store methods like <code>getState()</code>, so <code>store</code> stays available as the top-level argument.</p>
<h3 id="attempt-6-naïvely-applying-the-middleware"><span id="attempt-6-naïvely-applying-the-middleware" class="anchor enhancedAnchor_2LWZ"></span>Attempt #6: Naïvely Applying the Middleware<a href="#attempt-6-naïvely-applying-the-middleware" class="hash-link" title="Direct link to heading">#</a></h3>
<p>Instead of <code>applyMiddlewareByMonkeypatching()</code>, we could write <code>applyMiddleware()</code> that first obtains the final, fully wrapped <code>dispatch()</code> function, and returns a copy of the store using it:</p>
<p><span class="token comment" style="color: #c6cad2">// Warning: Naïve implementation!</span><span></span></p>
<p><span></span><span class="token comment" style="color: #c6cad2">// That’s *not* Redux API.</span><span></span></p>
<p><span></span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">applyMiddleware</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">store</span><span class="token parameter punctuation" style="color: #000000">,</span><span class="token parameter"> middlewares</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> middlewares </span><span class="token operator" style="color: #000000">=</span><span> middlewares</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">slice</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> middlewares</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">reverse</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">let</span><span> dispatch </span><span class="token operator" style="color: #000000">=</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">dispatch</span><span></span></p>
<p><span> middlewares</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">forEach</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">middleware</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">(</span><span>dispatch </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">middleware</span><span class="token punctuation" style="color: #000000">(</span><span>store</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">(</span><span>dispatch</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token known-class-name class-name">Object</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">assign</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">{</span><span class="token punctuation" style="color: #000000">}</span><span class="token punctuation" style="color: #000000">,</span><span> store</span><span class="token punctuation" style="color: #000000">,</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span> dispatch </span><span class="token punctuation" style="color: #000000">}</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span>The implementation of <a href="../../api/applymiddleware.html"><code>applyMiddleware()</code></a> that ships with Redux is similar, but <strong>different in three important aspects</strong>:</p>
<p>It only exposes a subset of the <a href="../../api/store.html">store API</a> to the middleware: <a href="../../api/store.html#dispatchaction"><code>dispatch(action)</code></a> and <a href="../../api/store.html#getState"><code>getState()</code></a>.</p>
<p>It does a bit of trickery to make sure that if you call <code>store.dispatch(action)</code> from your middleware instead of <code>next(action)</code>, the action will actually travel the whole middleware chain again, including the current middleware. <a href="../../tutorials/fundamentals/part-6-async-logic.html">This is useful for asynchronous middleware</a>. There is one caveat when calling <code>dispatch</code> during setup, described below.</p>
<p>To ensure that you may only apply middleware once, it operates on <code>createStore()</code> rather than on <code>store</code> itself. Instead of <code>(store, middlewares) =&gt; store</code>, its signature is <code>createStore()</code> before using it, <code>createStore()</code> accepts an optional last argument to specify such functions.</p>
<h4 id="caveat-dispatching-during-setup"><span id="caveat-dispatching-during-setup" class="anchor enhancedAnchor_2LWZ"></span>Caveat: Dispatching During Setup<a href="#caveat-dispatching-during-setup" class="hash-link" title="Direct link to heading">#</a></h4>
<p>While <code>applyMiddleware</code> executes and sets up your middleware, the <code>store.dispatch</code> function will point to the vanilla version provided by <code>createStore</code>. Dispatching would result in no other middleware being applied. If you are expecting an interaction with another middleware during setup, you will probably be disappointed. Because of this unexpected behavior, <code>applyMiddleware</code> will throw an error if you try to dispatch an action before the set up completes. Instead, you should either communicate directly with that other middleware via a common object (for an API-calling middleware, this may be your API client object) or waiting until after the middleware is constructed with a callback.</p>
<h3 id="the-final-approach"><span id="the-final-approach" class="anchor enhancedAnchor_2LWZ"></span>The Final Approach<a href="#the-final-approach" class="hash-link" title="Direct link to heading">#</a></h3>
<p>Given this middleware we just wrote:</p>
<p><span class="token keyword" style="color: #f92672">const</span><span> </span><span class="token function-variable function" style="color: #e6d874">logger</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token parameter">store</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">next</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">action</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘dispatching’</span><span class="token punctuation" style="color: #000000">,</span><span> action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">let</span><span> result </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘next state’</span><span class="token punctuation" style="color: #000000">,</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> result</span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> </span><span class="token function-variable function" style="color: #e6d874">crashReporter</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token parameter">store</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">next</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">action</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">try</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span> </span><span class="token keyword control-flow" style="color: #f92672">catch</span><span> </span><span class="token punctuation" style="color: #000000">(</span><span>err</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">error</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘Caught an exception!’</span><span class="token punctuation" style="color: #000000">,</span><span> err</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token maybe-class-name">Raven</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">captureException</span><span class="token punctuation" style="color: #000000">(</span><span>err</span><span class="token punctuation" style="color: #000000">,</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> extra</span><span class="token operator" style="color: #000000">:</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> action</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> state</span><span class="token operator" style="color: #000000">:</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">throw</span><span> err</span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span>Here’s how to apply it to a Redux store:</p>
<p><span class="token keyword module" style="color: #f92672">import</span><span> </span><span class="token imports punctuation" style="color: #000000">{</span><span> createStore</span><span class="token imports punctuation" style="color: #000000">,</span><span> combineReducers</span><span class="token imports punctuation" style="color: #000000">,</span><span> applyMiddleware </span><span class="token imports punctuation" style="color: #000000">}</span><span> </span><span class="token keyword module" style="color: #f92672">from</span><span> </span><span class="token string" style="color: #a6e22e">‘redux’</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> todoApp </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">combineReducers</span><span class="token punctuation" style="color: #000000">(</span><span>reducers</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> store </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">createStore</span><span class="token punctuation" style="color: #000000">(</span><span></span></p>
<p><span> todoApp</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> </span><span class="token comment" style="color: #c6cad2">// applyMiddleware() tells createStore() how to handle middleware</span><span></span></p>
<p><span> </span><span class="token function" style="color: #e6d874">applyMiddleware</span><span class="token punctuation" style="color: #000000">(</span><span>logger</span><span class="token punctuation" style="color: #000000">,</span><span> crashReporter</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">)</span>That’s it! Now any actions dispatched to the store instance will flow through <code>logger</code> and <code>crashReporter</code>:</p>
<p><span class="token comment" style="color: #c6cad2">// Will flow through both logger and crashReporter middleware!</span><span></span></p>
<p><span>store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">dispatch</span><span class="token punctuation" style="color: #000000">(</span><span class="token function" style="color: #e6d874">addTodo</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘Use Redux’</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span>## <span id="seven-examples" class="anchor enhancedAnchor_2LWZ"></span>Seven Examples<a href="#seven-examples" class="hash-link" title="Direct link to heading">#</a></p>
<p>If your head boiled from reading the above section, imagine what it was like to write it. This section is meant to be a relaxation for you and me, and will help get your gears turning.</p>
<p>Each function below is a valid Redux middleware. They are not equally useful, but at least they are equally fun.</p>
<p><span class="token comment" style="color: #c6cad2">/**</span></p>
<p><span class="token comment" style="color: #c6cad2"> * Logs all actions and states after they are dispatched.</span></p>
<p><span class="token comment" style="color: #c6cad2"> */</span><span></span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> </span><span class="token function-variable function" style="color: #e6d874">logger</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token parameter">store</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">next</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">action</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">group</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">type</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">info</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘dispatching’</span><span class="token punctuation" style="color: #000000">,</span><span> action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">let</span><span> result </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">log</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘next state’</span><span class="token punctuation" style="color: #000000">,</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">groupEnd</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> result</span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span></span><span class="token comment" style="color: #c6cad2">/**</span></p>
<p><span class="token comment" style="color: #c6cad2"> * Sends crash reports as state is updated and listeners are notified.</span></p>
<p><span class="token comment" style="color: #c6cad2"> */</span><span></span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> </span><span class="token function-variable function" style="color: #e6d874">crashReporter</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token parameter">store</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">next</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">action</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">try</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span> </span><span class="token keyword control-flow" style="color: #f92672">catch</span><span> </span><span class="token punctuation" style="color: #000000">(</span><span>err</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token console class-name">console</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">error</span><span class="token punctuation" style="color: #000000">(</span><span class="token string" style="color: #a6e22e">‘Caught an exception!’</span><span class="token punctuation" style="color: #000000">,</span><span> err</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token maybe-class-name">Raven</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">captureException</span><span class="token punctuation" style="color: #000000">(</span><span>err</span><span class="token punctuation" style="color: #000000">,</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> extra</span><span class="token operator" style="color: #000000">:</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> action</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> state</span><span class="token operator" style="color: #000000">:</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">getState</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">throw</span><span> err</span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span></span><span class="token comment" style="color: #c6cad2">/**</span></p>
<p><span class="token comment" style="color: #c6cad2"> * Schedules actions with { meta: { delay: N } } to be delayed by N milliseconds.</span></p>
<p><span class="token comment" style="color: #c6cad2"> * Makes `dispatch` return a function to cancel the timeout in this case.</span></p>
<p><span class="token comment" style="color: #c6cad2"> */</span><span></span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> </span><span class="token function-variable function" style="color: #e6d874">timeoutScheduler</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token parameter">store</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">next</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">action</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">if</span><span> </span><span class="token punctuation" style="color: #000000">(</span><span class="token operator" style="color: #000000">!</span><span>action</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">meta</span><span> </span><span class="token operator" style="color: #000000">||</span><span> </span><span class="token operator" style="color: #000000">!</span><span>action</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">meta</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">delay</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">const</span><span> timeoutId </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">setTimeout</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">,</span><span> action</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">meta</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">delay</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">cancel</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token function" style="color: #e6d874">clearTimeout</span><span class="token punctuation" style="color: #000000">(</span><span>timeoutId</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span></span><span class="token comment" style="color: #c6cad2">/**</span></p>
<p><span class="token comment" style="color: #c6cad2"> * Schedules actions with { meta: { raf: true } } to be dispatched inside a rAF loop</span></p>
<p><span class="token comment" style="color: #c6cad2"> * frame. Makes `dispatch` return a function to remove the action from the queue in</span></p>
<p><span class="token comment" style="color: #c6cad2"> * this case.</span></p>
<p><span class="token comment" style="color: #c6cad2"> */</span><span></span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> </span><span class="token function-variable function" style="color: #e6d874">rafScheduler</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token parameter">store</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">next</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">const</span><span> queuedActions </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token punctuation" style="color: #000000">[</span><span class="token punctuation" style="color: #000000">]</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">let</span><span> frame </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token keyword null nil" style="color: #f92672">null</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">loop</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> frame </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token keyword null nil" style="color: #f92672">null</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">try</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">if</span><span> </span><span class="token punctuation" style="color: #000000">(</span><span>queuedActions</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">length</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>queuedActions</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">shift</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span> </span><span class="token keyword control-flow" style="color: #f92672">finally</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token function" style="color: #e6d874">maybeRaf</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">maybeRaf</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">if</span><span> </span><span class="token punctuation" style="color: #000000">(</span><span>queuedActions</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">length</span><span> </span><span class="token operator" style="color: #000000">&amp;&amp;</span><span> </span><span class="token operator" style="color: #000000">!</span><span>frame</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> frame </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">requestAnimationFrame</span><span class="token punctuation" style="color: #000000">(</span><span>loop</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token parameter">action</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">if</span><span> </span><span class="token punctuation" style="color: #000000">(</span><span class="token operator" style="color: #000000">!</span><span>action</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">meta</span><span> </span><span class="token operator" style="color: #000000">||</span><span> </span><span class="token operator" style="color: #000000">!</span><span>action</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">meta</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">raf</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> queuedActions</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">push</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token function" style="color: #e6d874">maybeRaf</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">cancel</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> queuedActions </span><span class="token operator" style="color: #000000">=</span><span> queuedActions</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">filter</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">a</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> a </span><span class="token operator" style="color: #000000">!==</span><span> action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span></span><span class="token comment" style="color: #c6cad2">/**</span></p>
<p><span class="token comment" style="color: #c6cad2"> * Lets you dispatch promises in addition to actions.</span></p>
<p><span class="token comment" style="color: #c6cad2"> * If the promise is resolved, its result will be dispatched as an action.</span></p>
<p><span class="token comment" style="color: #c6cad2"> * The promise is returned from `dispatch` so the caller may handle rejection.</span></p>
<p><span class="token comment" style="color: #c6cad2"> */</span><span></span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> </span><span class="token function-variable function" style="color: #e6d874">vanillaPromise</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token parameter">store</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">next</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">action</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">if</span><span> </span><span class="token punctuation" style="color: #000000">(</span><span class="token keyword" style="color: #f92672">typeof</span><span> action</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">then</span><span> </span><span class="token operator" style="color: #000000">!==</span><span> </span><span class="token string" style="color: #a6e22e">‘function’</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">resolve</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">then</span><span class="token punctuation" style="color: #000000">(</span><span>store</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">dispatch</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span></span><span class="token comment" style="color: #c6cad2">/**</span></p>
<p><span class="token comment" style="color: #c6cad2"> * Lets you dispatch special actions with a { promise } field.</span></p>
<p><span class="token comment" style="color: #c6cad2"> *</span></p>
<p><span class="token comment" style="color: #c6cad2"> * This middleware will turn them into a single action at the beginning,</span></p>
<p><span class="token comment" style="color: #c6cad2"> * and a single success (or failure) action when the `promise` resolves.</span></p>
<p><span class="token comment" style="color: #c6cad2"> *</span></p>
<p><span class="token comment" style="color: #c6cad2"> * For convenience, `dispatch` will return the promise so the caller can wait.</span></p>
<p><span class="token comment" style="color: #c6cad2"> */</span><span></span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> </span><span class="token function-variable function" style="color: #e6d874">readyStatePromise</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token parameter">store</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">next</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">action</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">if</span><span> </span><span class="token punctuation" style="color: #000000">(</span><span class="token operator" style="color: #000000">!</span><span>action</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">promise</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">function</span><span> </span><span class="token function" style="color: #e6d874">makeAction</span><span class="token punctuation" style="color: #000000">(</span><span class="token parameter">ready</span><span class="token parameter punctuation" style="color: #000000">,</span><span class="token parameter"> data</span><span class="token punctuation" style="color: #000000">)</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">const</span><span> newAction </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token known-class-name class-name">Object</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">assign</span><span class="token punctuation" style="color: #000000">(</span><span class="token punctuation" style="color: #000000">{</span><span class="token punctuation" style="color: #000000">}</span><span class="token punctuation" style="color: #000000">,</span><span> action</span><span class="token punctuation" style="color: #000000">,</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span> ready </span><span class="token punctuation" style="color: #000000">}</span><span class="token punctuation" style="color: #000000">,</span><span> data</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">delete</span><span> newAction</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">promise</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> newAction</span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span class="token function" style="color: #e6d874">makeAction</span><span class="token punctuation" style="color: #000000">(</span><span class="token boolean" style="color: #ae81ff">false</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token keyword control-flow" style="color: #f92672">return</span><span> action</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">promise</span><span class="token punctuation" style="color: #000000">.</span><span style="color: #e6d874">then</span><span class="token punctuation" style="color: #000000">(</span><span></span></p>
<p><span> </span><span class="token parameter">result</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span class="token function" style="color: #e6d874">makeAction</span><span class="token punctuation" style="color: #000000">(</span><span class="token boolean" style="color: #ae81ff">true</span><span class="token punctuation" style="color: #000000">,</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span> result </span><span class="token punctuation" style="color: #000000">}</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> </span><span class="token parameter">error</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span class="token function" style="color: #e6d874">makeAction</span><span class="token punctuation" style="color: #000000">(</span><span class="token boolean" style="color: #ae81ff">true</span><span class="token punctuation" style="color: #000000">,</span><span> </span><span class="token punctuation" style="color: #000000">{</span><span> error </span><span class="token punctuation" style="color: #000000">}</span><span class="token punctuation" style="color: #000000">)</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">}</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span></span><span class="token comment" style="color: #c6cad2">/**</span></p>
<p><span class="token comment" style="color: #c6cad2"> * Lets you dispatch a function instead of an action.</span></p>
<p><span class="token comment" style="color: #c6cad2"> * This function will receive `dispatch` and `getState` as arguments.</span></p>
<p><span class="token comment" style="color: #c6cad2"> *</span></p>
<p><span class="token comment" style="color: #c6cad2"> * Useful for early exits (conditions over `getState()`), as well</span></p>
<p><span class="token comment" style="color: #c6cad2"> * as for async control flow (it can `dispatch()` something else).</span></p>
<p><span class="token comment" style="color: #c6cad2"> *</span></p>
<p><span class="token comment" style="color: #c6cad2"> * `dispatch` will return the return value of the dispatched function.</span></p>
<p><span class="token comment" style="color: #c6cad2"> */</span><span></span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> </span><span class="token function-variable function" style="color: #e6d874">thunk</span><span> </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token parameter">store</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">next</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span> </span><span class="token parameter">action</span><span> </span><span class="token arrow operator" style="color: #000000">=&gt;</span><span></span></p>
<p><span> </span><span class="token keyword" style="color: #f92672">typeof</span><span> action </span><span class="token operator" style="color: #000000">===</span><span> </span><span class="token string" style="color: #a6e22e">‘function’</span><span></span></p>
<p><span> </span><span class="token operator" style="color: #000000">?</span><span> </span><span class="token function" style="color: #e6d874">action</span><span class="token punctuation" style="color: #000000">(</span><span>store</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">dispatch</span><span class="token punctuation" style="color: #000000">,</span><span> store</span><span class="token punctuation" style="color: #000000">.</span><span class="token property-access">getState</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span> </span><span class="token operator" style="color: #000000">:</span><span> </span><span class="token function" style="color: #e6d874">next</span><span class="token punctuation" style="color: #000000">(</span><span>action</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span style="display: inline-block"> </span></p>
<p><span></span><span class="token comment" style="color: #c6cad2">// You can use all of them! (It doesn’t mean you should.)</span><span></span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> todoApp </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">combineReducers</span><span class="token punctuation" style="color: #000000">(</span><span>reducers</span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span></span><span class="token keyword" style="color: #f92672">const</span><span> store </span><span class="token operator" style="color: #000000">=</span><span> </span><span class="token function" style="color: #e6d874">createStore</span><span class="token punctuation" style="color: #000000">(</span><span></span></p>
<p><span> todoApp</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> </span><span class="token function" style="color: #e6d874">applyMiddleware</span><span class="token punctuation" style="color: #000000">(</span><span></span></p>
<p><span> rafScheduler</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> timeoutScheduler</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> thunk</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> vanillaPromise</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> readyStatePromise</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> logger</span><span class="token punctuation" style="color: #000000">,</span><span></span></p>
<p><span> crashReporter</span></p>
<p><span> </span><span class="token punctuation" style="color: #000000">)</span><span></span></p>
<p><span></span><span class="token punctuation" style="color: #000000">)</span><a href="prior-art.html" class="pagination-nav__link"></a></p>
<p>« Prior Art</p>
<p><a href="../../faq.html" class="pagination-nav__link"></a></p>
<p>Next</p>
<p>FAQ Index »</p>
<ul>
<li><a href="#understanding-middleware" class="table-of-contents__link">Understanding Middleware</a>
<ul>
<li><a href="#problem-logging" class="table-of-contents__link">Problem: Logging</a></li>
<li><a href="#attempt-1-logging-manually" class="table-of-contents__link">Attempt #1: Logging Manually</a></li>
<li><a href="#attempt-2-wrapping-dispatch" class="table-of-contents__link">Attempt #2: Wrapping Dispatch</a></li>
<li><a href="#attempt-3-monkeypatching-dispatch" class="table-of-contents__link">Attempt #3: Monkeypatching Dispatch</a></li>
<li><a href="#problem-crash-reporting" class="table-of-contents__link">Problem: Crash Reporting</a></li>
<li><a href="#attempt-4-hiding-monkeypatching" class="table-of-contents__link">Attempt #4: Hiding Monkeypatching</a></li>
<li><a href="#attempt-5-removing-monkeypatching" class="table-of-contents__link">Attempt #5: Removing Monkeypatching</a></li>
<li><a href="#attempt-6-naïvely-applying-the-middleware" class="table-of-contents__link">Attempt #6: Naïvely Applying the Middleware</a></li>
<li><a href="#the-final-approach" class="table-of-contents__link">The Final Approach</a></li>
</ul></li>
<li><a href="#seven-examples" class="table-of-contents__link">Seven Examples</a></li>
</ul>
<p><img src="../../../d33wubrfki0l68.cloudfront.net/0834d0215db51e91525a25acf97433051f280f2f/c30f5/img/redux.svg" alt="Redux Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo" /></a></p>
</body>
</html>
